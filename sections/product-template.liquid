{%- capture section_settings -%}
{
  "showShippingEstimator": {% if template == 'product.quick-view' or product.available == false %}false{% else %}{{ section.settings.show_shipping_estimator | json }}{% endif %},
  "showQuantitySelector": {{ section.settings.show_quantity_selector | json }},
  "showPaymentButton": {% if product.template_suffix == 'pre-order' %}false{% else %}{{ section.settings.show_payment_button | json }}{% endif %},
  "showInventoryQuantity": {% if product.template_suffix != 'pre-order' %}{{ section.settings.show_inventory_quantity | json }}{% else %}false{% endif %},
  "lowInventoryThreshold": {{ section.settings.low_inventory_threshold | json }},
  "galleryTransitionEffect": {{ section.settings.carousel_effect | json }},
  "enableImageZoom": {% if template == 'product.quick-view' %}false{% else %}{{ section.settings.enable_image_zoom | json }}{% endif %},
  "zoomEffect": {{ section.settings.zoom_effect | json }},
  "enableVideoLooping": {{ section.settings.enable_video_looping | json }},
  "productOptions": {{ product.options | json | escape }},
  "enableHistoryState": {% if template == 'product.quick-view' %}false{% else %}true{% endif %},
  "infoOverflowScroll": {% if template == 'product.quick-view' %}false{% else %}true{% endif %},
  "isQuickView": {% if template == 'product.quick-view' %}true{% else %}false{% endif %}
}
{%- endcapture -%}

<section data-section-id="{{ section.id }}" data-section-type="product" data-section-settings='{{ section_settings }}'>
  {%- if template != 'product.quick-view' -%}
    <div class="container container--flush">
      <div class="page__sub-header">
        <nav aria-label="{{ 'general.breadcrumb.title' | t }}" class="breadcrumb">
          <ol class="breadcrumb__list" role="list">
            <li class="breadcrumb__item">
              <a class="breadcrumb__link link" href="{{ routes.root_url }}">{{ 'general.breadcrumb.home' | t }}</a> {%- render 'icon', icon: 'arrow-right' -%}
            </li>

            <li class="breadcrumb__item">
              {%- if collection -%}
                <a class="breadcrumb__link link" href="{{ collection.url }}">{{ collection.title }}</a> {%- render 'icon', icon: 'arrow-right' -%}
              {%- else -%}
                <a class="breadcrumb__link link" href="{{ routes.all_products_collection_url }}">{{- 'collection.general.all_products' | t -}}</a> {%- render 'icon', icon: 'arrow-right' -%}
              {%- endif -%}
            </li>

            <li class="breadcrumb__item">
              <span class="breadcrumb__link" aria-current="page">{{ product.title | truncate: 40 }}</span>
            </li>
          </ol>
        </nav>

        <div class="page__navigation{% unless collection.previous_product != blank or collection.next_product != blank %} hidden{% endunless %}">
          {%- if settings.use_ls_urls -%}
            <span class="page__navigation-item page__navigation-item--prev">
              <a href="#" class="link" rel="prev">{%- render 'icon', icon: 'arrow-left' -%} {{- 'product.general.previous_product' | t -}}</a>
            </span>
            <span class="page__navigation-item page__navigation-item--next">
              <a href="#" class="link" rel="next">{{- 'product.general.next_product' | t -}} {%- render 'icon', icon: 'arrow-right' -%}</a>
            </span>
          {%- else -%}
            {%- if collection.previous_product != blank -%}
              <span class="page__navigation-item page__navigation-item--prev">
                <a href="{{ collection.previous_product.url }}" class="link" rel="prev">{%- render 'icon', icon: 'arrow-left' -%} {{- 'product.general.previous_product' | t -}}</a>
              </span>
            {%- endif -%}
            {%- if collection.next_product != blank -%}
              <span class="page__navigation-item page__navigation-item--next">
                <a href="{{ collection.next_product.url }}" class="link" rel="next">{{- 'product.general.next_product' | t -}} {%- render 'icon', icon: 'arrow-right' -%}</a>
              </span>
            {%- endif -%}
          {%- endif -%}
        </div>
      </div>

      <div class="product-block-list product-block-list--{{ section.settings.image_size }}">
        <div class="product-block-list__wrapper">
          {%- if product.media.size > 0 -%}
            <div class="product-block-list__item product-block-list__item--gallery">
              {% render 'product-gallery', are_images_lazy_loaded: false %}
            </div>
          {%- endif -%}

          <div class="product-block-list__item product-block-list__item--info" id="itemInfo">
            {% render 'product-info' %}
          </div>

          {%- if product.description != blank -%}
            <div class="product-block-list__item product-block-list__item--description">
              <div class="card">
                {%- if section.settings.content_display_mode == 'collapse_all' -%}
                  <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="product-description">
                    <span class="card__title heading h3">{{ 'product.general.description' | t }}</span>
                    <span class="plus-button plus-button--large"></span>
                  </button>

                  <div id="product-description" class="card__collapsible">
                    <div class="card__collapsible-content">
                      <div class="rte text--pull">
                        {{ product.description | remove: 'data-section-type="product"' }}
                      </div>
                    </div>
                  </div>
                {%- else -%}
                  <div class="card__header">
                    <h2 class="card__title heading h3">{{ 'product.general.description' | t }}</h2>
                  </div>

                  {%- if section.settings.content_display_mode == 'show_all_and_expand_description' -%}
                    <div class="card__section">
                      <div class="rte text--pull">
                        {{ product.description | remove: 'data-section-type="product"' }}
                      </div>
                    </div>
                  {%- else -%}
                    <div class="card__section expandable-content" aria-expanded="false">
                      <div class="rte text--pull">
                        {{ product.description | remove: 'data-section-type="product"' }}
                      </div>

                      <button class="expandable-content__toggle">
                        <span class="expandable-content__toggle-icon"></span>
                        <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                      </button>
                    </div>
                  {%- endif -%}
                {%- endif -%}
              </div>
            </div>
          {%- endif -%}

          {%- comment -%} Build a The Basics (renamed to How to Use) Card {%- endcomment -%}
          {%- if product.metafields.basics.basics_text != blank -%}
            <div class="product-block-list__item product-block-list__item--description">
                <div class="card">
                  {%- comment -%} to decide whether to collapse or show un-collapsed, check the two collapse settings, otherwise assume un-collapsed {%- endcomment -%}
                  {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                    {%- comment -%} display collapsed {%- endcomment -%}
                    <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="product-basics">
                      <span class="card__title heading h3">{{ 'product.general.basics' | t }}</span>
                      <span class="plus-button plus-button--large"></span>
                    </button>
                    <div id="product-basics" class="card__collapsible">
                      <div class="card__collapsible-content">
                        <div class="rte text--pull">
                          {{ product.metafields.basics.basics_text | remove: 'data-section-type="product"' }}
                        </div>
                      </div>
                    </div>
                  {%- else -%}
                    {%- comment -%} display un-collapsed {%- endcomment -%}
                    <div class="card__header">
                      <h2 class="card__title heading h3">{{ 'product.general.basics' | t }}</h2>
                    </div>
                    <div class="card__section expandable-content" aria-expanded="false">
                    <div class="rte text--pull">
                        {{ product.metafields.basics.basics_text | remove: 'data-section-type="product"' }}
                    </div>
                    <button class="expandable-content__toggle">
                        <span class="expandable-content__toggle-icon"></span>
                        <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                    </button>
                    </div>
                  {%- endif -%}
                </div>
              </div>
          {%- endif -%}


          {%- comment -%} Build a How to Use (renamed to Watch it in Action) card {%- endcomment -%}
          {%- if product.metafields.how_to_use.text != blank or product.metafields.how_to_use.video != blank -%}
            <div class="product-block-list__item product-block-list__item--description">
                <div class="card">
                  {%- comment -%} to decide whether to collapse or show un-collapsed, check the two collapse settings, otherwise assume un-collapsed {%- endcomment -%}
                  {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                    {%- comment -%} display collapsed {%- endcomment -%}
                    <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="product-how-to-use">
                      <span class="card__title heading h3">{{ 'product.general.how_to_use' | t }}</span>
                      <span class="plus-button plus-button--large"></span>
                    </button>
                    <div id="product-how-to-use" class="card__collapsible">
                      <div class="card__collapsible-content">
                        {%- if product.metafields.how_to_use.text != blank -%}
                          <div class="rte text--pull product-page-how-to-use-card-text">
                            {{ product.metafields.how_to_use.text }}
                          </div>
                        {%- endif -%}
                        {%- if product.metafields.how_to_use.video != blank and product.metafields.how_to_use.video contains '.mp4' and product.metafields.how_to_use.video_poster != blank -%}
                          <div class="card__video">
                            {%- render 'video-block',
                              video_url: product.metafields.how_to_use.video,
                              video_poster: product.metafields.how_to_use.video_poster,
                              video_ratio: '16x9',
                              autoplay: false,
                              controls: true
                            -%}
                          </div>
                        {%- endif -%}
                      </div>
                    </div>
                  {%- else -%}
                    {%- comment -%} display un-collapsed {%- endcomment -%}
                    <div class="card__header">
                      <h2 class="card__title heading h3">{{ 'product.general.how_to_use' | t }}</h2>
                    </div>
                    <div class="card__section expandable-content" aria-expanded="false">
                      {%- if product.metafields.how_to_use.text != blank -%}
                        <div class="rte text--pull">
                          {{ product.metafields.how_to_use.text }}
                        </div>
                      {%- endif -%}
                      {%- if product.metafields.how_to_use.video != blank and product.metafields.how_to_use.video contains '.mp4' and product.metafields.how_to_use.video_poster != blank -%}
                        <div class="card__video">
                          {%- render 'video-block',
                            video_url: product.metafields.how_to_use.video,
                            video_poster: product.metafields.how_to_use.video_poster,
                            video_ratio: '16x9',
                            autoplay: false,
                            controls: true
                          -%}
                        </div>
                      {%- endif -%}
                      <button class="expandable-content__toggle">
                          <span class="expandable-content__toggle-icon"></span>
                          <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                      </button>
                    </div>
                  {%- endif -%}
                </div>
              </div>
          {%- endif -%}


          {%- comment -%} Build a Product Features Card {%- endcomment -%}
          {%- if product.tags.size > 0 -%}
            {%- assign features_other = 'product.general.features_other' | t | append: '_' -%}
            {%- assign product_tags = '' -%}

            {%- for tag in product.tags -%}
              {%- unless tag contains '_' -%}
                {%- assign new_tag = tag | prepend: features_other -%}
                {%- assign product_tags = product_tags | append: new_tag | append: '|' -%}
              {%- else -%}
                {%- assign product_tags = product_tags | append: tag | append: '|' -%}
              {%- endunless -%}
            {%- endfor -%}
            {%- assign product_tags = product_tags | split: '|' | sort -%}
            
            {%- capture product_features -%}
              {%- assign last_tag_group = '' -%}
  
              {%- for tag in product_tags -%}
                {%- assign tag_group = tag | split: '_' | first -%}
                {%- assign tag_value = tag | split: '_' | last -%}
  
                {%- comment -%} Hide the Routine Essentials Filter Group in the Product Features card {%- endcomment -%}
                {%- if section.settings.hide_filter_group_routine_essentials_in_product_features_card and
                       tag_group == 'Routine Essentials' -%}
                  {%- continue -%}
                {%- endif -%}

                {%- if last_tag_group != tag_group -%}
                  {%- if last_tag_group != '' -%}</ul></div>{%- endif -%}
                  <div class="product-features__group">
                    <h3>{{ tag_group }}</h3>
                    <ul>
                      <li>{{ tag_value }}</li>
                {%- else -%}
                  <li>{{ tag_value }}</li>
                {%- endif -%}
  
                {%- assign last_tag_group = tag_group -%}
              {%- endfor -%}
            {%- endcapture -%}
            {%- if product_features != blank and last_tag_group != '' -%}
              {%- assign product_features = product_features | prepend: '<div class="product-features">' | append: '</ul></div></div>' -%}
            {%- endif -%}
            
            <div class="product-block-list__item product-block-list__item--description">
              <div class="card">
                {%- comment -%} to decide whether to collapse or show un-collapsed, check the two collapse settings, otherwise assume un-collapsed {%- endcomment -%}
                {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                  {%- comment -%} display collapsed {%- endcomment -%}
                  <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="product-features">
                    <span class="card__title heading h3">{{ 'product.general.features' | t }}</span>
                    <span class="plus-button plus-button--large"></span>
                  </button>
                  <div id="product-features" class="card__collapsible">
                    <div class="card__collapsible-content">{{ product_features }}</div>
                  </div>
                {%- else -%}
                  {%- comment -%} display un-collapsed {%- endcomment -%}
                  <div class="card__header">
                    <h2 class="card__title heading h3">{{ 'product.general.features' | t }}</h2>
                  </div>
                  <div class="card__section expandable-content" aria-expanded="false">
                    {{ product_features }}
                    <button class="expandable-content__toggle">
                      <span class="expandable-content__toggle-icon"></span>
                      <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                    </button>
                  </div>
                {%- endif -%}
              </div>
            </div>
          {%- endif -%}

          {%- comment -%} Build an Expert Review Card {%- endcomment -%}
          {%- if product.metafields.expert_review.expert_review_text != blank -%}
            <div class="product-block-list__item product-block-list__item--description">
                <div class="card">
                  {%- comment -%} to decide whether to collapse or show un-collapsed, check the two collapse settings, otherwise assume un-collapsed {%- endcomment -%}
                  {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                    {%- comment -%} display collapsed {%- endcomment -%}
                    <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="product-expert-review">
                      <span class="card__title heading h3">{{ 'product.general.expert_review' | t }}</span>
                      <span class="plus-button plus-button--large"></span>
                    </button>
                    <div id="product-expert-review" class="card__collapsible">
                      <div class="card__collapsible-content">
                        <div class="rte text--pull">
                          {{ product.metafields.expert_review.expert_review_text | remove: 'data-section-type="product"' }}
                        </div>
                      </div>
                    </div>
                  {%- else -%}
                    {%- comment -%} display un-collapsed {%- endcomment -%}
                    <div class="card__header">
                      <h2 class="card__title heading h3">{{ 'product.general.expert_review' | t }}</h2>
                    </div>
                    <div class="card__section expandable-content" aria-expanded="false">
                    <div class="rte text--pull">
                        {{ product.metafields.expert_review.expert_review_text | remove: 'data-section-type="product"' }}
                    </div>
                    <button class="expandable-content__toggle">
                        <span class="expandable-content__toggle-icon"></span>
                        <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                    </button>
                    </div>
                  {%- endif -%}
                </div>
              </div>
          {%- endif -%}

          {%- comment -%} Build a Key Ingredients Card {%- endcomment -%}
          {%- if product.metafields.ingredients.ingredients_text != blank -%}
            <div class="product-block-list__item product-block-list__item--description">
                <div class="card">
                  {%- comment -%} to decide whether to collapse or show un-collapsed, check the two collapse settings, otherwise assume un-collapsed {%- endcomment -%}
                  {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                    {%- comment -%} display collapsed {%- endcomment -%}
                    <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="product-ingredients">
                      <span class="card__title heading h3">{{ 'product.general.ingredients' | t }}</span>
                      <span class="plus-button plus-button--large"></span>
                    </button>
                    <div id="product-ingredients" class="card__collapsible">
                      <div class="card__collapsible-content">
                        <div class="rte text--pull">
                          {%- if section.settings.split_ingredients_by_comma_delimiter -%}
                            {%- assign ingredientsFieldDelimiter = ',' -%}
                            {%- assign listOfIngredients = product.metafields.ingredients.ingredients_text | remove: 'data-section-type="product"' | split : ingredientsFieldDelimiter | sort | uniq -%}
                            {%- comment -%} TODO : Strip whitespace within each string of the array. Not so straightforward to do in Liquid. {%- endcomment -%}
                            <ul>
                            {%- for ingredient in listOfIngredients -%}
                              <li> {{ ingredient }} </li>
                            {%- endfor -%}
                            </ul>
                          {%- else -%}
                            {{ product.metafields.ingredients.ingredients_text | remove: 'data-section-type="product"' }}
                          {%- endif -%}
                          <div class="product-page-ingredients-card-footnote-text">
                            {{ 'product.general.ingredients_footnote' | t | escape }}
                          </div>
                        </div>
                      </div>
                    </div>
                  {%- else -%}
                    {%- comment -%} display un-collapsed {%- endcomment -%}
                    <div class="card__header">
                      <h2 class="card__title heading h3">{{ 'product.general.ingredients' | t }}</h2>
                    </div>
                    <div class="card__section expandable-content" aria-expanded="false">
                        <div class="rte text--pull">
                            {{ product.metafields.ingredients.ingredients_text | remove: 'data-section-type="product"' }}
                            <div class="product-page-ingredients-card-footnote-text">
                                {{ 'product.general.ingredients_footnote' | t | escape }}
                            </div>
                        </div>
                        <button class="expandable-content__toggle">
                            <span class="expandable-content__toggle-icon"></span>
                            <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                        </button>
                    </div>
                  {%- endif -%}
                </div>
              </div>
          {%- endif -%}

          {%- comment -%} CTA to Brand Collection {%- endcomment -%}
          {%- liquid
            assign brand_collection_handle = product.metafields.brand.brand_collection_url
            assign brand_collection = collections[brand_collection_handle]
            assign brand_collection_url = ''
            assign brand_name = ''

            if brand_collection_handle != '' and brand_collection.url != ''
              assign brand_collection_url = brand_collection.url
              assign brand_name = brand_collection.title

              if product.metafields.brand.brand_name != ''
                assign brand_name = product.metafields.brand.brand_name
              endif
            endif
          -%}

          {%- if brand_collection_url != '' -%}
            <div class="product-block-list__item product-block-list__item--description">
                <div class="card">
                  {%- comment -%} to decide whether to collapse or show un-collapsed, check the two collapse settings, otherwise assume un-collapsed {%- endcomment -%}
                  {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                    {%- comment -%} display collapsed {%- endcomment -%}
                    <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="product-view-brand-collection">
                      <span class="card__title heading h3">{{ 'product.general.view_brand_collection' | t }}</span>
                      <span class="plus-button plus-button--large"></span>
                    </button>
                    <div id="product-view-brand-collection" class="card__collapsible">
                      <div class="card__collapsible-content">
                        <div class="rte text--pull">
                            <a href="{{ brand_collection_url }}" class="button button--secondary">{{ 'product.general.view_brand_collection_button_text' | t }} {{ brand_name }}</a>
                        </div>
                      </div>
                    </div>
                  {%- else -%}
                    {%- comment -%} display un-collapsed {%- endcomment -%}
                    <div class="card__header">
                      <h2 class="card__title heading h3">{{ 'product.general.view_brand_collection' | t }}</h2>
                    </div>
                    <div class="card__section expandable-content" aria-expanded="false">
                    <div class="rte text--pull">
                        <a href="{{ brand_collection_url }}" class="button button--secondary">{{ 'product.general.view_brand_collection_button_text' | t }} {{ brand_name }}</a>
                    </div>
                    <button class="expandable-content__toggle">
                        <span class="expandable-content__toggle-icon"></span>
                        <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                    </button>
                    </div>
                  {%- endif -%}
                </div>
              </div>
          {%- endif -%}


          {%- comment -%}
          --------------------------------------------------------------------------------------
          TABS
          --------------------------------------------------------------------------------------
          {%- endcomment -%}

          {%- for i in (1..5) -%}
            {%- assign unique_tab_title = '' -%}
            {%- assign unique_tab_content = '' -%}

            {%- comment -%}First check for metafields{%- endcomment -%}

            {%- assign metafield_tab_title_option = 'tab_' | append: i | append: '_title' -%}
            {%- assign metafield_tab_content_option = 'tab_' | append: i | append: '_content' -%}

            {%- if product.metafields.sf_product_tabs[metafield_tab_title_option] != blank and product.metafields.sf_product_tabs[metafield_tab_content_option] != blank -%}
              {%- assign unique_tab_title = product.metafields.sf_product_tabs[metafield_tab_title_option] -%}
              {%- assign unique_tab_content = product.metafields.sf_product_tabs[metafield_tab_content_option] -%}
            {%- else -%}
              {%- assign tab_to_look = '__tab' | append: i | append: ':' -%}

              {%- for tag in product.tags -%}
                {%- if tag contains tab_to_look -%}
                  {%- assign unique_tab_handle = tag | split: tab_to_look | last -%}
                  {%- assign unique_tab_page = pages[unique_tab_handle] -%}

                  {%- unless unique_tab_page.empty? -%}
                    {%- assign unique_tab_title = unique_tab_page.title -%}
                    {%- assign unique_tab_content = unique_tab_page.content -%}
                    {%- break -%}
                  {%- endunless -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}

            {%- if unique_tab_title != blank and unique_tab_content != blank -%}
              <div class="product-block-list__item product-block-list__item--content">
                <div class="card">
                  {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                    <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="unique-tab-{{ i }}">
                      <span class="card__title heading h3">{{ unique_tab_title }}</span>
                      <span class="plus-button plus-button--large"></span>
                    </button>

                    <div id="unique-tab-{{ i }}" class="card__collapsible">
                      <div class="card__collapsible-content">
                        <div class="rte text--pull">
                          {{ unique_tab_content }}
                        </div>
                      </div>
                    </div>
                  {%- else -%}
                    <div class="card__header">
                      <h2 class="card__title heading h3">{{ unique_tab_title }}</h2>
                    </div>

                    <div class="card__section expandable-content" aria-expanded="false">
                      <div class="rte text--pull">
                        {{ unique_tab_content }}
                      </div>

                      <button class="expandable-content__toggle">
                        <span class="expandable-content__toggle-icon"></span>
                        <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                      </button>
                    </div>
                  {%- endif -%}
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}

          {%- for i in (1..3) -%}
            {%- assign global_tab_option = 'tab_page_' | append: i | append: '_handle' -%}
            {%- assign global_tab_page = pages[section.settings[global_tab_option]] -%}

            {%- unless global_tab_page.empty? -%}
              <div class="product-block-list__item product-block-list__item--content">
                <div class="card">
                  {%- if section.settings.content_display_mode == 'collapse_all_except_description' or section.settings.content_display_mode == 'collapse_all' -%}
                    <button class="card__collapsible-button" data-action="toggle-collapsible" aria-expanded="false" aria-controls="global-tab-{{ i }}">
                      <span class="card__title heading h3">{{ global_tab_page.title }}</span>
                      <span class="plus-button plus-button--large"></span>
                    </button>

                    <div id="global-tab-{{ i }}" class="card__collapsible">
                      <div class="card__collapsible-content">
                        <div class="rte text--pull">
                          {{ global_tab_page.content }}
                        </div>
                      </div>
                    </div>
                  {%- else -%}
                    <div class="card__header">
                      <h2 class="card__title heading h3">{{ global_tab_page.title }}</h2>
                    </div>

                    <div class="card__section expandable-content" aria-expanded="false">
                      <div class="rte text--pull">
                        {{ global_tab_page.content }}
                      </div>

                      <button class="expandable-content__toggle">
                        <span class="expandable-content__toggle-icon"></span>
                        <span class="expandable-content__toggle-text" data-view-more="{{ 'product.general.view_more' | t | escape }}" data-view-less="{{ 'product.general.view_less' | t | escape }}">{{- 'product.general.view_more' | t -}}</span>
                      </button>
                    </div>
                  {%- endif -%}
                </div>
              </div>
            {%- endunless -%}
          {%- endfor -%}

          {%- comment -%}
          --------------------------------------------------------------------------------------
          REVIEWS
          --------------------------------------------------------------------------------------
          {%- endcomment -%}

          {%- if section.settings.enable_reviews -%}
            <div class="product-block-list__item product-block-list__item--reviews">
              <span id="product-reviews" class="anchor"></span>

              <div class="card">
                <div class="card__section">
                  {%- assign reviews_count = product.metafields.spr.reviews | split: '<meta itemprop="reviewCount" content="' | last | split: '">' | first | times: 1 -%}
                  <div id="shopify-product-reviews" class="spr-reviews {% if reviews_count > 0 %}spr-reviews--has-reviews{% endif %}" data-id="{{ product.id }}">{{ product.metafields.spr.reviews }}</div>
                </div>
              </div>
            </div>
          {%- endif -%}

          {%- comment -%}
          --------------------------------------------------------------------------------------
          SECURITY BADGES
          --------------------------------------------------------------------------------------
          {%- endcomment -%}

          {%- if section.settings.show_payment_icons and shop.enabled_payment_types.size > 0 -%}
            {%- assign show_payment_icons = true -%}
          {%- else -%}
            {%- assign show_payment_icons = false -%}
          {%- endif -%}

          {%- if section.settings.custom_security_badge or show_payment_icons -%}
            <div class="product-block-list__item product-block-list__item--trust">
              <div class="card">
                <div class="card__header card__header--flex">
                  <h2 class="card__title heading h3">{{ section.settings.trust_title | escape }}</h2>

                  {%- render 'icon', icon: 'lock', width: 22, height: 24 -%}
                </div>

                <div class="card__section">
                  {%- if show_payment_icons -%}
                    {%- if section.settings.custom_security_badge -%}
                      <p class="card__subtitle heading h6">{{ 'product.general.payment' | t }}</p>
                    {%- endif -%}

                    <div class="payment-list">
                      {% for type in shop.enabled_payment_types %}
                        {{ type | payment_type_svg_tag: class: 'payment-list__item' }}
                      {% endfor %}
                    </div>

                    <p class="payment-list__notice">{{ 'product.general.payment_notice' | t }}</p>
                  {%- endif -%}

                  {%- if show_payment_icons and section.settings.custom_security_badge -%}
                    <hr class="card__separator">
                  {%- endif -%}

                  {%- if section.settings.custom_security_badge -%}
                    {%- if show_payment_icons -%}
                      <p class="card__subtitle heading h6">{{ 'product.general.security' | t }}</p>
                    {%- endif -%}

                    {%- assign badge_width = section.settings.custom_security_badge.width | at_most: 450 | append: 'x' -%}
                    <img class="product__trust-badge" style="width: {{ section.settings.custom_security_badge_width }}px"
                         src="{{ section.settings.custom_security_badge | img_url: badge_width }}"
                         srcset="{{ section.settings.custom_security_badge | img_url: badge_width }} 1x, {{ section.settings.custom_security_badge | img_url: badge_width, scale: 2 }} 2x"
                         alt="{{ section.settings.custom_security_badge.alt | escape }}">
                  {%- endif -%}
                </div>
              </div>
            </div>
          {%- endif -%}

          {%- comment -%}
          --------------------------------------------------------------------------------------
          BACK TO TOP BUTTON
          --------------------------------------------------------------------------------------
          {%- endcomment -%}

          {%- if section.settings.enable_back_to_top_btn -%}
            <div class="product-block-list__item product-block-list__item--btn">
              <div class="product-block-list__item--btn__wrap">
                <a href="#itemInfo">
                  <svg focusable="false" viewBox="0 0 8 12" role="presentation">
                    <path stroke="currentColor" stroke-width="2" d="M2 2l4 4-4 4" fill="none" stroke-linecap="square"></path>
                  </svg>
                  <span>{{section.settings.back_to_top_btn_label}}</span>
                </a>
              </div>
            </div>
          {%- endif -%}

          {%- comment -%}
          --------------------------------------------------------------------------------------
          ESTIMATE SHIPPING
          --------------------------------------------------------------------------------------
          {%- endcomment -%}

          {%- if section.settings.show_shipping_estimator and product.available -%}
            <div class="product-block-list__item product-block-list__item--shipping">
              <div class="card">
                <div class="card__header">
                  <h2 class="card__title heading h3">{{ 'product.general.estimate_shipping' | t }}</h2>
                </div>

                <div class="card__section">
                  <div class="shipping-estimator form" role="form">
                    <div class="form__input-row">
                      <div class="form__input-wrapper">
                        <label for="shipping-estimator-country" class="form__label">{{ 'cart.shipping_estimator.country' | t }}</label>

                        <div class="select-wrapper select-wrapper--primary">
                          {%- render 'icon', icon: 'arrow-bottom' -%}

                          <select name="country" id="shipping-estimator-country" data-default="{{ customer.default_address.country | default: section.settings.shipping_estimator_default_country }}" required>
                            {{- country_option_tags -}}
                          </select>
                        </div>
                      </div>

                      <div class="form__input-wrapper" style="display: none">
                        <label for="shipping-estimator-province" class="form__label">{{ 'cart.shipping_estimator.province' | t }}</label>

                        <div class="select-wrapper select-wrapper--primary">
                          {%- render 'icon', icon: 'arrow-bottom' -%}

                          <select name="province" id="shipping-estimator-province" data-default="{{ customer.default_address.province }}"></select>
                        </div>
                      </div>

                      <div class="form__input-wrapper" style="max-width: 155px">
                        <label for="shipping-estimator-zip" class="form__label">{{ 'cart.shipping_estimator.zip_code' | t }}</label>
                        <input type="text" name="zip" id="shipping-estimator-zip" class="form__field form__field--text" value="{{ customer.default.address.zip }}" required>
                      </div>
                    </div>

                    <button type="button" class="form__submit button button--primary" data-action="estimate-shipping">{{ 'cart.shipping_estimator.estimate' | t }}</button>

                    <div class="shipping-estimator__results rte" style="display: none;"></div>
                  </div>
                </div>

                {%- if section.settings.show_refunds_policy and shop.refund_policy != blank -%}
                  <div class="card__section card__section--tight">
                    <button class="product__refund-policy-link link link--accented" data-action="open-modal" aria-controls="modal-refunds-policy">{{ 'product.general.refund_policy' | t }} {%- render 'icon', icon: 'arrow-right' -%}</button>
                  </div>
                {%- endif -%}
              </div>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>

    {%- if section.settings.show_refunds_policy and shop.refund_policy != blank -%}
      <div id="modal-refunds-policy" class="modal" aria-hidden="true">
        <div class="modal__dialog" role="dialog">
          <header class="modal__header">
            <h3 class="modal__title heading h2">{{ 'product.general.refund_policy' | t }}</h3>
            <button class="modal__close link" data-action="close-modal" title="{{ 'general.accessibility.close' | t | escape }}">
              {%- render 'icon', icon: 'close' -%}
            </button>
          </header>

          <div class="modal__content">
            <div class="rte">
              {{ shop.refund_policy }}
            </div>
          </div>
        </div>
      </div>
    {%- endif -%}
  {%- else -%}
    {%- comment -%}We display the quick view within the product template so we can re-use the same settings{%- endcomment -%}
    <div class="featured-product">
      {%- comment -%}do not lazy load images on product gallery, since these are visible on page load above fold, to speed up initial load times{%- endcomment -%}
      {%- render 'product-gallery', are_images_lazy_loaded: false -%}
      {%- render 'product-info', show_rating: section.settings.show_rating -%}
    </div>
  {%- endif -%}
</section>

{% schema %}
{
  "name": "Product page",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_sku",
      "label": "Show SKU",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show Loox Reviews Star Rating",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_share_buttons",
      "label": "Show share buttons",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_taxes_included",
      "label": "Show price taxes notice",
      "default": false
    },
    {
      "type": "select",
      "id": "selector_mode",
      "label": "Selector type",
      "options": [
        {
          "value": "block",
          "label": "Block"
        },
        {
          "value": "dropdown",
          "label": "Dropdown"
        }
      ],
      "default": "block"
    },
    {
      "type": "select",
      "id": "color_mode",
      "label": "Color selector type",
      "info": "Variant image mode requires that all variant has an associated image. [Learn more](https://help.shopify.com/en/manual/products/product-variant-images#add-images-to-existing-variants)",
      "options": [
        {
          "value": "block",
          "label": "Block"
        },
        {
          "value": "dropdown",
          "label": "Dropdown"
        },
        {
          "value": "color",
          "label": "Color swatch"
        },
        {
          "value": "variant_image",
          "label": "Variant image"
        }
      ],
      "default": "color"
    },
    {
      "type": "checkbox",
      "id": "show_quantity_selector",
      "label": "Show quantity selector",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_payment_button",
      "label": "Show dynamic checkout button",
      "info": "Each customer will see their preferred payment method from those available on your store, such as PayPal or Apple Pay. [Learn more](https://help.shopify.com/manual/using-themes/change-the-layout/dynamic-checkout)",
      "default": true
    },
    {
      "type": "header",
      "content": "Info after Price Form",
      "info" : "Section containing elements after the Price Form, which currently ends at the Purchasing buttons"
    },
    {
      "type": "checkbox",
      "id": "show_pickup_availability",
      "label": "Show local pickup availability",
      "info": "Show customers where they can pick up the product. [Learn more](https://help.shopify.com/en/manual/shipping/setting-up-and-managing-your-shipping/local-methods/local-pickup#show-pickup-availability-to-your-customers)",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_shipping_text",
      "label": "Show Shipping Text",
      "default": false
    },
    {
      "type": "text",
      "id": "shipping_text",
      "label": "Shipping Text",
      "default": "Standard tracked shipping £4.99. FREE tracked shipping on orders above £35."
    },
    {
      "type": "checkbox",
      "id": "show_trust_signal",
      "label": "Show Trust Signal",
      "default": false
    },
    {
      "type": "text",
      "id": "header_text_trust_signal",
      "label": "Header Text for Trust Signal",
      "default": "Trusted by our Customers"
    },
    {
        "type": "checkbox",
        "id": "show_klarna_onsite_messaging_placement",
        "label": "Show Klarna Onsite Messaging Placement",
        "default": false
    },
    {
      "type": "header",
      "content": "Product Features Card"
    },
    {
      "type": "checkbox",
      "id": "hide_filter_group_routine_essentials_in_product_features_card",
      "label": "Hide Routine Essentials Filter Group",
      "default": false
    },
    {
      "type": "header",
      "content": "Ingredients Card"
    },
    {
      "type": "checkbox",
      "id": "split_ingredients_by_comma_delimiter",
      "label": "Split Ingredients by Comma Delimiter",
      "default": false
    },
    {
      "type": "header",
      "content": "Media"
    },
    {
      "type": "paragraph",
      "content": "Learn more about [media types](https://help.shopify.com/en/manual/products/product-media)"
    },
    {
      "type": "select",
      "id": "image_size",
      "label": "Size",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ],
      "default": "small"
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Enable video looping",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_image_zoom",
      "label": "Enable image zoom",
      "default": true
    },
    {
      "type": "select",
      "id": "zoom_effect",
      "label": "Desktop zoom effect",
      "options": [
        {
          "value": "inside",
          "label": "Inside"
        },
        {
          "value": "outside",
          "label": "Outside"
        }
      ],
      "default": "outside"
    },
    {
      "type": "select",
      "id": "carousel_effect",
      "label": "Transition effect",
      "options": [
        {
          "value": "fade",
          "label": "Fade"
        },
        {
          "value": "slide",
          "label": "Slide"
        }
      ],
      "default": "fade"
    },
    {
      "type": "header",
      "content": "Inventory"
    },
    {
      "type": "paragraph",
      "content": "You can also add a stock countdown. [Learn more](https://support.maestrooo.com/article/177-product-show-an-stock-countdown-bar)."
    },
    {
      "type": "checkbox",
      "id": "show_inventory_quantity",
      "label": "Show inventory quantity",
      "default": false
    },
    {
      "type": "range",
      "id": "low_inventory_threshold",
      "label": "Low inventory threshold",
      "info": "Use low stock color when quantity is below the threshold. Choose 0 to always show in stock.",
      "min": 0,
      "max": 50,
      "step": 1,
      "default": 0
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "paragraph",
      "content": "You can also add per-product tabs. [Learn more](http://support.maestrooo.com/article/83-product-adding-different-tabs-per-product)."
    },
    {
      "type": "select",
      "id": "content_display_mode",
      "label": "Display mode",
      "options": [
        {
          "value": "show_all",
          "label": "Show all"
        },
        {
          "value": "show_all_and_expand_description",
          "label": "Show all and expand description"
        },
        {
          "value": "collapse_all",
          "label": "Collapse all"
        },
        {
          "value": "collapse_all_except_description",
          "label": "Collapse all except description"
        }
      ],
      "default": "show_all_and_expand_description"
    },
    {
      "type": "page",
      "id": "tab_page_1_handle",
      "label": "First page"
    },
    {
      "type": "page",
      "id": "tab_page_2_handle",
      "label": "Second page"
    },
    {
      "type": "page",
      "id": "tab_page_3_handle",
      "label": "Third page"
    },
    {
      "type": "header",
      "content": "Reviews"
    },
    {
      "type": "paragraph",
      "content": "You need to install [Shopify's free Product Reviews](https://apps.shopify.com/product-reviews) app before enabling those options."
    },
    {
      "type": "checkbox",
      "id": "enable_reviews",
      "label": "Enable",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_reviews_badge",
      "label": "Show badge",
      "default": false
    },
    {
      "type": "header",
      "content": "Trust"
    },
    {
      "type": "text",
      "id": "trust_title",
      "label": "Heading",
      "default": "Payment & Security"
    },
    {
      "type": "checkbox",
      "id": "show_payment_icons",
      "label": "Show payment icons",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "custom_security_badge",
      "label": "Security badge",
      "info": "800 x 200px .jpg recommended"
    },
    {
      "type": "range",
      "id": "custom_security_badge_width",
      "min": 100,
      "max": 500,
      "step": 10,
      "unit": "px",
      "label": "Security badge width",
      "default": 200
    },
    {
      "type": "header",
      "content": "Back to top button"
    },
    {
      "type": "checkbox",
      "id": "enable_back_to_top_btn",
      "label": "Enable Back to top button",
      "default": true
    },
    {
      "type": "text",
      "id": "back_to_top_btn_label",
      "label": "Button inner text",
      "default": "Back to top"
    },
    {
      "type": "header",
      "content": "Shipping estimator"
    },
    {
      "type": "checkbox",
      "id": "show_shipping_estimator",
      "label": "Show shipping estimator",
      "info": "Only show if product is available.",
      "default": true
    },
    {
      "type": "text",
      "id": "shipping_estimator_default_country",
      "label": "Default country",
      "info": "If the customer is logged in, the country of their shipping address will be used.",
      "default": "United States"
    },
    {
      "type": "checkbox",
      "id": "show_refunds_policy",
      "label": "Show refunds policy",
      "info": "Refund policy must be added into your store policies. [Learn more](https://help.shopify.com/manual/sell-online/checkout-settings/refund-privacy-tos).",
      "default": true
    }
  ]
}
{% endschema %}

{%- comment -%}
Vig : removing Loox's Aggregate Rating Google structured Data snippet
      the problem was that it is not being merged by ID into the main Product schema
      which is in snippets/microdata-schema.liquid
      because the main Product element does not specify this ID
      instead of adding an ID to the main element, I am nesting the aggregateRating
      key into the main Product element instead

{% if product.metafields.loox.num_reviews %}
<script id="looxSchemaJson" type="application/ld+json">
{
	"@context": "http://schema.org",
	"@type": "Product",
	"@id": {{ canonical_url | json }},
	"aggregateRating": {
		"@type": "AggregateRating",
		"ratingValue": "{{ product.metafields.loox.avg_rating }}",
		"reviewCount": "{{ product.metafields.loox.num_reviews }}"
	},
	"name": {{ product.title | json }}
    {% if product.metafields.loox.reviewsSchema %}
	,"review" : {{ product.metafields.loox.reviewsSchema }}
{% endif %}
}
</script>
{% endif %}

{%- endcomment -%}

<div id="looxReviews" data-product-id="{{product.id}}" class="loox-reviews-default">{{ product.metafields.loox.reviews }}</div>